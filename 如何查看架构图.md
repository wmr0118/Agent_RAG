# 如何查看架构图

## 📊 图表格式说明

文档中的图表使用的是 **Mermaid** 格式，这是一种文本化的图表描述语言。

## 🔍 查看方式

### 方式1：在VS Code/Cursor中查看（推荐）

1. **安装Mermaid扩展**：
   - 在VS Code/Cursor中搜索并安装 `Markdown Preview Mermaid Support` 扩展
   - 或者安装 `Mermaid Preview` 扩展

2. **预览Markdown文件**：
   - 打开 `ARCHITECTURE.md` 文件
   - 按 `Cmd+Shift+V` (Mac) 或 `Ctrl+Shift+V` (Windows) 预览
   - 图表会自动渲染显示

### 方式2：在线查看器

1. **Mermaid Live Editor**（最简单）：
   - 访问：https://mermaid.live/
   - 复制文档中的 ````mermaid` 代码块内容
   - 粘贴到编辑器中，图表会自动显示

2. **GitHub/GitLab**：
   - 如果项目托管在GitHub或GitLab上
   - 直接在网页上查看 `ARCHITECTURE.md`，图表会自动渲染

3. **其他在线工具**：
   - https://mermaid-js.github.io/mermaid-live-editor/
   - https://www.mermaidchart.com/

### 方式3：导出为图片

1. 在 Mermaid Live Editor 中打开图表
2. 点击右上角的下载按钮
3. 选择导出为 PNG 或 SVG 格式

## 📖 如何理解架构图

### 1. 系统架构图（第一个图）

**图的方向**：
- 从上到下（Top to Bottom）
- 箭头 `-->` 表示依赖关系或调用关系

**颜色含义**：
- 🔵 蓝色：入口层（RAGSystem）
- 🟡 黄色：Agent层（智能体相关）
- 🟢 绿色：核心RAG层（检索和生成）
- 🟣 紫色：查询处理层（路由和分类）
- 🔴 粉色：记忆层（历史记忆）
- 🟢 青色：工具层（外部工具）

**阅读方式**：
1. **从入口开始**：找到 `RAGSystem`（蓝色框）
2. **跟随箭头**：看它连接了哪些模块
3. **理解层次**：
   - 上层模块依赖下层模块
   - 例如：`RAGChain` 依赖 `BaseRetriever` 和 `AnswerGenerator`
   - `BaseRetriever` 又依赖 `VectorStore` 和 `EmbeddingManager`

**关键路径**：
```
用户查询 
  → RAGSystem 
    → QueryRouter (路由决策)
      → ReActAgent (Agent模式) 或 RAGChain (基础模式)
        → BaseRetriever (检索文档)
        → AnswerGenerator (生成答案)
```

### 2. 数据流图（第二个图）

**图的方向**：
- 从左到右（时序图）
- 展示查询处理的完整流程

**阅读方式**：
1. **从上到下**：按时间顺序阅读
2. **箭头方向**：
   - `->>` 表示返回结果
   - `->` 表示调用请求
3. **分支说明**：
   - `alt` 表示条件分支（Agent模式 或 基础RAG模式）
   - `loop` 表示循环（ReAct循环）

**关键流程**：
```
1. 用户提交查询
2. 检索历史记忆
3. 查询路由（改写+分类）
4. 根据策略选择处理方式
   - Agent模式：多步推理循环
   - 基础RAG：单次检索+生成
5. 存储交互到记忆库
6. 返回答案给用户
```

### 3. 模块依赖关系图（第三个图）

**图的方向**：
- 从左到右（依赖层级）
- L1 → L2 → L3 → L4 → L5 表示依赖层级

**阅读方式**：
- **L1（基础设施层）**：最底层，不依赖其他业务模块
- **L2（核心组件层）**：依赖基础设施
- **L3（组合组件层）**：组合多个核心组件
- **L4（智能组件层）**：使用组合组件实现智能功能
- **L5（应用层）**：最顶层，协调所有组件

## 🎯 快速理解要点

### 核心模块识别

1. **入口**：`RAGSystem` - 系统主入口
2. **路由决策**：`QueryRouter` - 决定使用哪种处理方式
3. **两种处理模式**：
   - `ReActAgent` - 智能Agent模式（复杂问题）
   - `RAGChain` - 基础RAG模式（简单问题）
4. **核心功能**：
   - `BaseRetriever` - 检索相关文档
   - `AnswerGenerator` - 生成答案
5. **辅助功能**：
   - `MemoryStore/Retriever` - 记忆管理
   - `ToolRegistry` - 工具管理
   - `IndexManager` - 索引管理

### 数据流向

```
用户问题 
  ↓
记忆检索（历史上下文）
  ↓
查询路由（意图分类）
  ↓
┌─────────────┬─────────────┐
│ Agent模式   │ 基础RAG模式  │
│ (复杂推理)  │ (简单查询)   │
└─────────────┴─────────────┘
  ↓
检索文档 + 生成答案
  ↓
存储记忆
  ↓
返回答案
```

## 💡 实用技巧

1. **先看整体**：先理解整个系统的分层结构
2. **再看细节**：深入某个模块时，看它的依赖关系
3. **追踪数据流**：从用户查询到答案返回的完整路径
4. **理解设计意图**：为什么这样分层？为什么需要路由？

## 🔧 如果图表无法显示

如果您的编辑器不支持Mermaid，可以：

1. **使用在线工具**：复制代码到 https://mermaid.live/
2. **查看文本描述**：文档中有详细的文字说明
3. **查看依赖表**：文档中有"详细模块依赖表"

## 📝 示例：如何追踪一个查询

假设用户问："Python如何读取文件？"

1. **RAGSystem.query()** 接收问题
2. **MemoryRetriever** 检索相关历史对话
3. **QueryRouter.route()** 路由查询
   - **QueryRewriter** 改写查询（如果需要）
   - **IntentClassifier** 分类意图 → "FACTUAL"（事实查询）
4. **策略选择**：基础RAG模式（简单事实查询）
5. **RAGChain.query()** 执行
   - **BaseRetriever.retrieve()** 检索文档
   - **AnswerGenerator.generate()** 生成答案
6. **MemoryStore.store_interaction()** 存储交互
7. 返回答案给用户



